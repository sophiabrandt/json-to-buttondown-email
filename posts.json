{"titles":[" TIL: Sqlite Foreign Key Support (with Go)"],"content":"\n  <p>Hello ðŸ‘‹! Thanks for subscribing.</p>\n  \n  <h2><a href=https://www.rockyourcode.com/til-sqlite-foreign-key-support-with-go/>TIL: Sqlite Foreign Key Support (with Go)</a></h2>\n  <p>Published on: 2021-03-06</p>\n  <p>tags: TIL, SQL, Go</p>\n  <p>Using foreign key constraints with SQL databases is very common. You can use those constrains to model relationships between tables.</p>\n<p>Here is an example:</p>\n<div class=\"highlight\"><pre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"><code class=\"language-sql\" data-lang=\"sql\"><span style=\"color:#66d9ef\">CREATE</span> <span style=\"color:#66d9ef\">TABLE</span> artist(\n  artistid    INTEGER <span style=\"color:#66d9ef\">PRIMARY</span> <span style=\"color:#66d9ef\">KEY</span>,\n  artistname  TEXT\n);\n<span style=\"color:#66d9ef\">CREATE</span> <span style=\"color:#66d9ef\">TABLE</span> track(\n  trackid     INTEGER,\n  trackname   TEXT,\n  trackartist INTEGER <span style=\"color:#66d9ef\">REFERENCES</span> artist(artistid) <span style=\"color:#75715e\">-- Must map to an artist.artistid!\n</span><span style=\"color:#75715e\"></span>);\n</code></pre></div><p><strong><a href=\"https://www.sqlite.org\">Sqlite</a></strong> is a small and self-contained implementation of SQL. <a href=\"https://litestream.io/blog/why-i-built-litestream/\">SQLite databases are used in production</a> all around the world.</p>\n<p>There is only a small pitfall with foreign key constraints using SQLite: it&rsquo;s <em>not</em> enabled per default (for backwards compatibility).</p>\n<p>Unfortunately, that means that you have to enable the support manually for each database connection:</p>\n<div class=\"highlight\"><pre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"><code class=\"language-bash\" data-lang=\"bash\">sqlite&gt; PRAGMA foreign_keys <span style=\"color:#f92672\">=</span> ON;\n</code></pre></div><p>I&rsquo;ve been using SQLite for my <a href=\"https://github.com/sophiabrandt/go-maybe-list\">Go web application</a>, so let&rsquo;s see how we can write a small wrapper for Go.</p>\n<div class=\"highlight\"><pre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"><code class=\"language-go\" data-lang=\"go\"><span style=\"color:#f92672\">package</span> <span style=\"color:#a6e22e\">database</span>\n\n<span style=\"color:#f92672\">import</span> (\n\t<span style=\"color:#e6db74\">&#34;github.com/jmoiron/sqlx&#34;</span>\n\t<span style=\"color:#e6db74\">&#34;github.com/pkg/errors&#34;</span>\n\t<span style=\"color:#a6e22e\">_</span> <span style=\"color:#e6db74\">&#34;modernc.org/sqlite&#34;</span>\n)\n\n<span style=\"color:#75715e\">// New returns a new database connection pool.\n</span><span style=\"color:#75715e\"></span><span style=\"color:#66d9ef\">func</span> <span style=\"color:#a6e22e\">New</span>(<span style=\"color:#a6e22e\">dbName</span> <span style=\"color:#66d9ef\">string</span>) (<span style=\"color:#f92672\">*</span><span style=\"color:#a6e22e\">sqlx</span>.<span style=\"color:#a6e22e\">DB</span>, <span style=\"color:#66d9ef\">error</span>) {\n\t<span style=\"color:#a6e22e\">db</span>, <span style=\"color:#a6e22e\">err</span> <span style=\"color:#f92672\">:=</span> <span style=\"color:#a6e22e\">sqlx</span>.<span style=\"color:#a6e22e\">Open</span>(<span style=\"color:#e6db74\">&#34;sqlite&#34;</span>, <span style=\"color:#e6db74\">&#34;database.sqlite&#34;</span>)\n\t<span style=\"color:#66d9ef\">if</span> <span style=\"color:#a6e22e\">err</span> <span style=\"color:#f92672\">!=</span> <span style=\"color:#66d9ef\">nil</span> {\n\t\t<span style=\"color:#66d9ef\">return</span> <span style=\"color:#66d9ef\">nil</span>, <span style=\"color:#a6e22e\">errors</span>.<span style=\"color:#a6e22e\">Wrap</span>(<span style=\"color:#a6e22e\">err</span>, <span style=\"color:#e6db74\">&#34;Unable to open database&#34;</span>)\n\t}\n\t<span style=\"color:#66d9ef\">if</span> <span style=\"color:#a6e22e\">err</span> = <span style=\"color:#a6e22e\">db</span>.<span style=\"color:#a6e22e\">Ping</span>(); <span style=\"color:#a6e22e\">err</span> <span style=\"color:#f92672\">!=</span> <span style=\"color:#66d9ef\">nil</span> {\n\t\t<span style=\"color:#66d9ef\">return</span> <span style=\"color:#66d9ef\">nil</span>, <span style=\"color:#a6e22e\">errors</span>.<span style=\"color:#a6e22e\">Wrap</span>(<span style=\"color:#a6e22e\">err</span>, <span style=\"color:#e6db74\">&#34;Unable to ping database&#34;</span>)\n\t}\n\n\t<span style=\"color:#66d9ef\">const</span> <span style=\"color:#a6e22e\">q</span> = <span style=\"color:#e6db74\">`\n</span><span style=\"color:#e6db74\">\tPRAGMA foreign_keys = ON;\n</span><span style=\"color:#e6db74\">\tPRAGMA synchronous = NORMAL;\n</span><span style=\"color:#e6db74\">\tPRAGMA journal_mode = &#39;WAL&#39;;\n</span><span style=\"color:#e6db74\">\tPRAGMA cache_size = -64000;\n</span><span style=\"color:#e6db74\">\t`</span>\n\t<span style=\"color:#a6e22e\">_</span>, <span style=\"color:#a6e22e\">err</span> = <span style=\"color:#a6e22e\">db</span>.<span style=\"color:#a6e22e\">Exec</span>(<span style=\"color:#a6e22e\">q</span>)\n\t<span style=\"color:#66d9ef\">if</span> <span style=\"color:#a6e22e\">err</span> <span style=\"color:#f92672\">!=</span> <span style=\"color:#66d9ef\">nil</span> {\n\t\t<span style=\"color:#66d9ef\">return</span> <span style=\"color:#66d9ef\">nil</span>, <span style=\"color:#a6e22e\">errors</span>.<span style=\"color:#a6e22e\">Wrap</span>(<span style=\"color:#a6e22e\">err</span>, <span style=\"color:#e6db74\">&#34;Unable to set pragmas&#34;</span>)\n\t}\n\n\t<span style=\"color:#66d9ef\">return</span> <span style=\"color:#a6e22e\">db</span>, <span style=\"color:#66d9ef\">nil</span>\n}\n</code></pre></div><p>I can now use this function in <a href=\"https://github.com/sophiabrandt/go-maybe-list/blob/cd6ce5d86321f2f38aa67bc3b5b5ee118ace4be8/cmd/web/main.go#L53\"><code>main.go</code></a> and be sure that my database connection has the correct settings:</p>\n<div class=\"highlight\"><pre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"><code class=\"language-go\" data-lang=\"go\"><span style=\"color:#a6e22e\">dbName</span> <span style=\"color:#f92672\">:=</span> <span style=\"color:#a6e22e\">flag</span>.<span style=\"color:#a6e22e\">String</span>(<span style=\"color:#e6db74\">&#34;dbName&#34;</span>, <span style=\"color:#e6db74\">&#34;database.sqlite&#34;</span>, <span style=\"color:#e6db74\">&#34;database name&#34;</span>)\n\t<span style=\"color:#a6e22e\">flag</span>.<span style=\"color:#a6e22e\">Parse</span>()\n\n<span style=\"color:#a6e22e\">db</span>, <span style=\"color:#a6e22e\">err</span> <span style=\"color:#f92672\">:=</span> <span style=\"color:#a6e22e\">database</span>.<span style=\"color:#a6e22e\">New</span>(<span style=\"color:#f92672\">*</span><span style=\"color:#a6e22e\">dbName</span>)\n\t<span style=\"color:#66d9ef\">if</span> <span style=\"color:#a6e22e\">err</span> <span style=\"color:#f92672\">!=</span> <span style=\"color:#66d9ef\">nil</span> {\n\t\t<span style=\"color:#66d9ef\">return</span> <span style=\"color:#a6e22e\">errors</span>.<span style=\"color:#a6e22e\">Wrap</span>(<span style=\"color:#a6e22e\">err</span>, <span style=\"color:#e6db74\">&#34;could not start server&#34;</span>)\n\t}\n\t<span style=\"color:#66d9ef\">defer</span> <span style=\"color:#a6e22e\">db</span>.<span style=\"color:#a6e22e\">Close</span>()\n</code></pre></div><h2 id=\"further-reading\">Further Reading</h2>\n<ul>\n<li><a href=\"https://news.ycombinator.com/item?id=26103776\">Hacker News Discussion: Why I Build Litestream</a></li>\n<li><a href=\"https://www.sqlite.org/foreignkeys.html\">SQLite Foreign Key Support</a></li>\n</ul>\n\n  <hr />\n  <p>Thank you for reading my blog posts.</p>\n  <p>Don't hesitate to reach out via <a href=\"mailto:hi@rockyourcode.com\">email</a> or <a href=\"https://twitter.com/hisophiabrandt\">Twitter</a>!\n  "}